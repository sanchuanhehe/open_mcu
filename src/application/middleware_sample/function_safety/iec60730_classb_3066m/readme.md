# MCU芯片功能安全classb参考示例
## 关键字: IEC60730，ClassB，启动诊断，运行时诊断，最小诊断单元process配置，时间性能测量，表驱动

**【功能描述】**
+ function_safety功能安全库中间件通过对功能安全处理流程进行抽象，提炼出用户侧最小配置单元function_safety_process, 应用侧基于表驱动的方式进行启动和运行时诊断处理，用户只需实例配置启动和运行时的诊断流程process，即可自动完成新增process处理流程注册到启动和运行时的处理流程中，用户只需根据具体项目需求选择功能安全库提供的诊断接口和配置对应的初始化配置即可。function_safety_init初始化相关接口是基于功能安全各子系统handle句柄的相关配置，是底层驱动和function_safety中间件之间的适配层，generatecode是基于IDE配置生成的芯片初始化配置代码，是底层驱动和芯片之间的适配层。功能安全中间件处理流程提供了诊断前备份功能和诊断后恢复功能，需要用户根据实际项目封装对应的接口，通过process配置注册到对应的函数指针上即可完成无损诊断，用户根据实际工程应用配置底层驱动初始化代码，诊断前调用备份函数备份工程应用的初始化配置，诊断后恢复功能应用的初始化配置，不影响用户实际应用的初始化配置，便于用户工程应用的配置集成。

**【示例配置】**
+ contexBackupFunc 上下文备份配置（可选）：通过上下文备份可以实现实际应用的无损诊断，用于诊断前备份用户通过IDE配置生成的实际工程应用底层驱动配置。

+ handleConfigFunc 功能安全适配层初始化配置（可选）：用于配置各子系统诊断函数所需的初始化配置，该适配层可完成底层驱动配置的修改和上层诊断指标的设定。

+ diagnoseFunc 诊断函数配置（可选）：功能安全诊断接口，用户可选择function_safety中间件提供的各子系统诊断接口，也可自行封装对应的诊断接口。

+ failSafeFunc 失效安全函数配置（可选）：基于诊断结果实施失效安全配置，该示例中为了便于演示，默认配置均为while(1)死循环的方式定住程序。该函数为__weak函数，用户可自定义进行钩子函数挂载。

+ faultPredictFunc 故障预测函数配置（可选）：该功能function_safety安全包暂未提供，主要用于诊断正常的前提下进行故障预测。

+ contexResumeFunc 上下文恢复配置（可选）：诊断后上下文配置恢复函数，诊断完成后恢复工程应用的底层驱动配置。示例中暂未提供，用户可根据实际项目进行配置封装接口。

+ contexHandle 上下文备份恢复参数句柄（可选）：上下文备份和恢复的句柄指针，可用户指向备份区。

+ diagnoseHandle 诊断参数句柄（可选）：诊断函数入参，用户可按照结构体定义进行配置。

+ failSafeHandle 失效安全参数句柄（可选）：失效安全函数入参，用户可按照结构体定义进行配置。

+ faultPredictHandle 故障预测参数句柄（可选）：故障预测函数入参，用户可按照结构体定义进行配置。

+ moment 诊断时刻参数句柄（可选）：故障预测函数入参，用户可按照结构体定义进行配置。

+ timeCycleRecordSwitch 时间cycle测量开关（可选）：默认不开，用户可配置是否开启，用于记录打印处理流程中各阶段的耗时以及状态。


**【示例效果】**
+ 当用户烧录编译后的示例代码后，通过串口可以看到启动和运行时处理流程process的诊断信息，包含功能安全状态码，状态码的含义可以参照FunctionSafetyState结构体的位定义，每个子系统的模块和特性在对应头文件中右定义，通过功能安全状态码能了解当前诊断的子系统和模块以及特性的诊断结果和时间性能。

**【注意事项】**
+ 示例代码使用UART0进行结果打印输出，需要对UART0进行初始化配置。
+ 此示例init文件夹下的工程初始化配置是基于3066MNPIRH芯片工程生成的。
+ 不通过IDE创建生成场景：初始化配置请参考sample下的init文件内容。
+ 通过IDE创建生成场景：初始化配置请参考user/generatecode下的文件内容。
+ 必须勾选上工程配置菜单中的“生成CRC”选项，ROM测试会用到，否则ROM完整性诊断会报异常，且不可通过仿真模式进行烧录，否则会缺少bin文件末尾的CRC校验码、
+ 如果诊断出看门狗复位异常时想消除该异常，则目标板需要重新上下电，否则会一直检测到看门狗复位异常。